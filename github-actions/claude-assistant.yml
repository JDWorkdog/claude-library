# Claude Library - Claude Assistant Workflow
# Responds to @claude mentions in issues and PRs
# Add this to your project's .github/workflows/ directory

name: Claude Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  respond:
    runs-on: ubuntu-latest
    # Only run if comment mentions @claude
    if: contains(github.event.comment.body, '@claude')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Extract Question
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            // Extract text after @claude mention
            const question = comment.replace(/@claude\s*/i, '').trim();
            core.setOutput('question', question);
            return question;

      - name: Get Context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            let context_text = '';

            if (context.payload.issue) {
              context_text = `Issue #${context.payload.issue.number}: ${context.payload.issue.title}\n\n${context.payload.issue.body}`;
            }

            if (context.payload.pull_request) {
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number
              });
              context_text = `PR #${pr.data.number}: ${pr.data.title}\n\n${pr.data.body}`;
            }

            core.setOutput('context', context_text);
            return context_text;

      - name: Run Claude
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          RESPONSE=$(claude-code --print "Context: ${{ steps.context.outputs.context }}

          Question: ${{ steps.extract.outputs.question }}

          Please provide a helpful response. If code changes are needed, provide specific suggestions.")
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Response
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.claude.outputs.response }}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Claude Response\n\n${response}`
            });
